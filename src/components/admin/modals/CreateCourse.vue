<template>
	<div class="m-md-5">
		<div class="d-flex align-items-baseline justify-content-between my-3">
			<a @click.prevent="setCreateModalOverview"><i class="fas fa-arrow-left"></i></a>
			<h4>Create Course</h4>
			<i></i>
		</div>
		<form>
			<div v-if="page === 1">
				<div class="form-group my-3">
					<input type="text" id="title" class="form-control" placeholder="Title" v-model.trim="$v.course.title.$model"
						:class="{'is-invalid': $v.course.title.$error, 'is-valid': !$v.course.title.$invalid}">
				</div>
				<div class="form-group my-3">
					<textarea id="description" class="form-control" placeholder="Course Description" rows="4" v-model.trim="$v.course.description.$model"
                        :class="{'is-invalid': $v.course.description.$error, 'is-valid': !$v.course.description.$invalid}"
					></textarea>
				</div>
				<div class="form-group my-3">
					<h6>Tags</h6>
					<div class="custom-control custom-checkbox d-inline-block mx-1"  v-for="tag in tags" :key="tag.name">
						<input type="checkbox" class="custom-control-input" :id="tag.name"  v-model="$v.course.tags.$model" :value="tag.name">
						<label class="custom-control-label" :for="tag.name">{{ tag.name }}</label>
					</div>
					<small id="tagsHelpBlock" class="form-text" :class="$v.course.tags.$error ? 'text-danger' : 'text-muted'">
						Please select at least one tag
					</small>
				</div>
				<div class="d-flex justify-content-end my-3">
					<button @click.prevent="goToNext" :class="cannotGoToNext ? 'opacity-25' : 'bg-info'" :disabled="cannotGoToNext">
						<span>Next</span>
						<i class="fas fa-angle-right ml-2"></i>
					</button>
				</div>
			</div>
			<div v-if="page === 2">
				<div class="form-group my-3">
					<input type="file" @change="catchVideo" class="d-none" ref="videoInput" accept="video/*">
					<a @click.prevent="$refs.videoInput.click()">
						<span v-if="video">{{video.name}} </span>
						<span class="text-info">Upload video</span>
					</a>
				</div>
				<div class="form-group my-3">
					<input type="file" @change="catchImage" class="d-none" ref="imageInput" accept="image/*">
					<a @click.prevent="$refs.imageInput.click()">
						<span v-if="image">{{image.name}} </span>
						<span class="text-info">Upload image preview</span>
					</a>
				</div>
				<div class="custom-control custom-checkbox my-3">
					<input type="checkbox" class="custom-control-input" id="isPremium"  v-model="$v.course.premium.$model"
						:class="$v.course.premium.$error ? 'text-danger' : 'text-muted'">
					<label class="custom-control-label" for="isPremium">Is course premium?</label>
				</div>
				<div v-if="course.premium" class="form-group my-3">
					<input type="file" @change="catchPreview" class="d-none" ref="previewInput" accept="video/*">
					<a @click.prevent="$refs.previewInput.click()">
						<span v-if="preview">{{preview.name}}  </span>
						<span class="text-info">Upload video preview</span>
					</a>
				</div>
				<div class="form-group my-3">
					<input type="file" @change="catchDocuments" class="d-none" ref="documentInput" multiple>
					<span>{{ documents.map(doc => doc.name).join(', ') }} </span>
					<a class="text-info" @click.prevent="$refs.documentInput.click()">Upload attachment files</a>
				</div>
				<div class="d-flex justify-content-between align-items-center my-3">
					<button class="bg-info" @click.prevent="goToPrevious">
						<i class="fas fa-angle-left mr-2"></i>
						<span>Previous</span>
					</button>
					<button @click.prevent="submitCourse" :class="{'opacity-25':$v.$invalid || needsPreview, 'primary-button': !$v.$invalid && !needsPreview}" :disabled="cannotSubmit">
						<i class="fas fa-spinner fa-spin" v-if="isLoading"></i>
						<span v-else>Submit</span>
					</button>
				</div>
			</div>
		</form>
	</div>
</template>


<script>
	import { mapActions } from 'vuex'
	import { firestore } from '@/config/firebase'
	import { required, minLength, requiredIf } from 'vuelidate/lib/validators'
	export default {
		name: 'CreateCourse',
		data: () => ({
			course: {
				title: '',
				description: '',
				premium: false,
				tags: []
			},
			video: null,
			image: null,
			preview: null,
			documents: [],
			tags: [],
			isLoading: false,
			page: 1
		}),
		async mounted(){
			let docs = await firestore.collection('subjects').get()
			docs.forEach(doc => this.tags.push({ '.key': doc.id, ...doc.data() }))
		},
		computed: {
			cannotGoToNext(){ return this.$v.course.title.$invalid || this.$v.course.description.$invalid || this.$v.course.tags.$invalid },
			needsPreview(){ return this.course.premium === true && !this.preview },
			cannotSubmit(){ return this.$v.$invalid || this.isLoading || this.needsPreview }
		},
		methods: {
			...mapActions(['setCreateModalOverview', 'closeCreateModal','createCourse']),
			goToNext(){ this.page = 2},
			goToPrevious(){ this.page = 1},
			catchVideo(e){ e.target.files[0] && e.target.files[0].type.startsWith('video/') ? this.video = e.target.files[0] : new window.Toast({ icon:'error', title: 'File is not a video'})},
			catchImage(e){ e.target.files[0] &&e.target.files[0].type.startsWith('image/') ? this.image = e.target.files[0] : new window.Toast({ icon:'error', title: 'File is not an image'})},
			catchPreview(e){ e.target.files[0] && e.target.files[0].type.startsWith('video/') ? this.preview = e.target.files[0] : new window.Toast({ icon:'error', title: 'File is not a video'})},
			catchDocuments(e){ this.documents = [...e.target.files] },
			async submitCourse(){
				this.isLoading = true
				try{
					await this.createCourse({
						video: this.video, image: this.image, documents: this.documents, course: this.course, preview: this.preview
					})
					this.closeCreateModal()
					new window.Toast({ icon: 'success', title: 'Course created successfully' })
				}catch(error){ new window.Toast({ icon: 'error', title: error.message }) }
				this.isLoading = false
			}
		},
		validations: {
			course: {
				title: { required, minLength: minLength(3) },
				description: { required, minLength: minLength(3) },
				premium: { required },
				tags: { required, minLength: minLength(1) },
			},
			video: { required },
			image: { required },
			preview: { requiredIf: requiredIf('course.premium') },
			documents: { required, minLength: minLength(1) }
		}
	}
</script>

<style lang="scss" scoped>
	@import '../../../style/index';
	input{
		padding: 1rem;
		max-width: 700px;
	}
	.form-group{
		margin: 1rem 0;
	}
	button{
		margin: 0.5rem 0;
		padding: 0.5rem 1.5rem;
		color: $white;
		display: block;
		min-width: 150px;
	}
</style>