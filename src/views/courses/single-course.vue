<template>
	<Default>
		<helper-spinner v-if="isLoading"/>
		<div v-else>
			<single-video :course="course" />
			<single-nav />
			<single-overview v-if="isOverview" :course="course" />
			<single-discussions v-if="isDiscussions" :course="course" />
			<single-documents v-if="isDocuments" :course="course" />
		</div>
	</Default>
</template>

<script>
	import { firestore } from '@/config/firebase'
	import HelperSpinner from '@/components/helpers/Spinner'
	import SingleVideo from '@/components/courses/single/SingleVideo'
	import SingleNav from '@/components/courses/single/SingleNav'
	import SingleOverview from '@/components/courses/single/SingleOverview'
	import SingleDiscussions from '@/components/courses/single/SingleDiscussions'
	import SingleDocuments from '@/components/courses/single/SingleDocuments'
	export default {
		name: 'Course',
		data: () => ({
			course: {},
			isLoading: true
		}),
		async mounted(){
			try{
				let doc = await firestore.collection('courses').doc(this.$route.params.id).get()
				if(!doc.exists){ return await this.$router.replace('/courses') }
				this.course = { '.key': doc.id, ...doc.data() }
			}catch(error){ new window.Toast({ icon: 'error', title: 'Error fetching course. Try refreshing the page' }) }
			this.isLoading = false
			window.Fire.$on('CourseEdited', course => course['.key'] === this.course['.key'] ? this.course = course : null)
			window.Fire.$on('CourseDeleted', course => course['.key'] === this.course['.key'] ? this.$router.push('/courses') : null)
		},
		components: {
			'single-video': SingleVideo,
			'single-nav': SingleNav,
			'single-overview': SingleOverview,
			'single-discussions': SingleDiscussions,
			'single-documents': SingleDocuments,
			'helper-spinner': HelperSpinner
		},
		computed:{
			isOverview(){ return !this.$route.query.tab || this.$route.query.tab === 'overview'},
			isDiscussions(){ return this.$route.query.tab && this.$route.query.tab === 'discussions'},
			isDocuments(){ return this.$route.query.tab && this.$route.query.tab === 'documents'},
		},
		meta(){
			return {
				title: this.course.title || 'Course Title',
				meta: [
					{
						vmid: 'description',
						name: 'description',
						content: this.course.description || ''
					},
					{
						vmid: 'keywords',
						name: 'keywords',
						content: [].join(', ')
					}
				]
			}
		}
	}
</script>
